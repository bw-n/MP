window.addEventListener("load", () => {
  setTimeout(() => {
    const grid = document.getElementById("grid");
    const filtersWrapper = document.getElementById("filters");

    if (!grid) {
      console.error("⛔ Élément #grid introuvable !");
      return;
    }

    fetch("dbx.dat")
      .then((res) => res.json())
      .then((data) => {
        // Compléter jusqu’à 100 emplacements
        for (let i = data.length; i < 100; i++) {
          data.push({ id: i });
        }

        data.forEach((entry) => {
          const slot = document.createElement("div");
          slot.className = "slot";

          // Ajout des tags
          if (entry.tag) {
            const tagsArray = Array.isArray(entry.tag) ? entry.tag : [entry.tag];
            slot.setAttribute("data-tag", tagsArray.join(","));
          }

          // Création du tooltip
          const tooltip = document.createElement("div");
          tooltip.className = "tooltip";
          let tooltipText = entry.label || "Emplacement libre";
          if (entry.tag) {
            const tagText = Array.isArray(entry.tag) ? entry.tag.join(", ") : entry.tag;
            tooltipText += ` (${tagText})`;
          }
          tooltip.textContent = tooltipText;

          // Affichage de l’image + lien
          if (entry.href && entry.image) {
            const link = document.createElement("a");
            link.href = entry.href;
            link.target = "_blank";
            link.rel = "noopener noreferrer";

            const img = document.createElement("img");
            img.src = entry.image;
            img.alt = entry.label || "";

            link.appendChild(img);
            slot.appendChild(link);
          }
          // Image seule sans lien
          else if (entry.image) {
            const img = document.createElement("img");
            img.src = entry.image;
            img.alt = entry.label || "";
            slot.appendChild(img);
          }
          // Slot vide
          else {
            slot.classList.add("empty");
            slot.textContent = "+";
          }

          slot.appendChild(tooltip);
          grid.appendChild(slot);
        });

        // Gestion des filtres
        const filterButtons = document.querySelectorAll("#filters button[data-tag]");
        filterButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const selectedTag = button.getAttribute("data-tag");

            filterButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");

            document.querySelectorAll(".slot").forEach((slot) => {
              const tags = (slot.getAttribute("data-tag") || "")
                .split(",")
                .map((t) => t.trim());

              if (selectedTag === "all") {
                slot.classList.remove("tag-active", "tag-muted");
              } else if (tags.includes(selectedTag)) {
                slot.classList.add("tag-active");
                slot.classList.remove("tag-muted");
              } else {
                slot.classList.remove("tag-active");
                slot.classList.add("tag-muted");
              }
            });
          });
        });
      })
      .catch((err) => {
        console.error("❌ Erreur JSON :", err);
      });
  }, 0);
});
